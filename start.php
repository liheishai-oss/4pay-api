#!/usr/bin/env php
<?php
chdir(__DIR__);
require_once __DIR__ . '/vendor/autoload.php';

// Âä†ËΩΩÁéØÂ¢ÉÂèòÈáè
loadEnvFile();

// Ê£ÄÊü• Telegram Webhook ‰ø°ÊÅØ
checkTelegramWebhook();

support\App::run();

/**
 * Âä†ËΩΩ .env Êñá‰ª∂
 */
function loadEnvFile()
{
    $envFile = __DIR__ . '/.env';
    if (file_exists($envFile)) {
        $lines = file($envFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
        foreach ($lines as $line) {
            if (strpos(trim($line), '#') === 0) {
                continue; // Ë∑≥ËøáÊ≥®ÈáäË°å
            }
            
            if (strpos($line, '=') !== false) {
                list($key, $value) = explode('=', $line, 2);
                $key = trim($key);
                $value = trim($value);
                
                // ÁßªÈô§ÂºïÂè∑
                if (($value[0] ?? '') === '"' && ($value[-1] ?? '') === '"') {
                    $value = substr($value, 1, -1);
                } elseif (($value[0] ?? '') === "'" && ($value[-1] ?? '') === "'") {
                    $value = substr($value, 1, -1);
                }
                
                if (!getenv($key)) {
                    putenv("{$key}={$value}");
                    $_ENV[$key] = $value;
                    $_SERVER[$key] = $value;
                }
            }
        }
    }
}

/**
 * Ê£ÄÊü• Telegram Webhook ‰ø°ÊÅØ
 */
function checkTelegramWebhook()
{
    try {
        $botToken = getenv('TELEGRAM_BOT_TOKEN') ?: config('telegram.bot_token', '');
        
        if (empty($botToken)) {
            echo "‚ö†Ô∏è  Telegram Bot Token Êú™ÈÖçÁΩÆ\n";
            echo "üîß Ê≠£Âú®Â∞ùËØïËá™Âä®ÈÖçÁΩÆ...\n\n";
            
            // Â∞ùËØïËá™Âä®ÈÖçÁΩÆ
            if (autoConfigureTelegram()) {
                echo "‚úÖ Telegram ÈÖçÁΩÆÂÆåÊàêÔºåÈáçÊñ∞Ê£ÄÊü• Webhook...\n\n";
                // ÈáçÊñ∞Ëé∑ÂèñÈÖçÁΩÆ
                $botToken = config('telegram.bot_token', '');
            } else {
                echo "‚ùå Ëá™Âä®ÈÖçÁΩÆÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®ÈÖçÁΩÆ\n";
                showConfigurationGuide();
                return;
            }
        }

        echo "üîç Ê≠£Âú®Ê£ÄÊü• Telegram Webhook ‰ø°ÊÅØ...\n";
        
        $apiUrl = "https://api.telegram.org/bot{$botToken}/getWebhookInfo";
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $apiUrl);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        curl_setopt($ch, CURLOPT_USERAGENT, 'Webman-Telegram-Webhook-Checker/1.0');

        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $curlError = curl_error($ch);
        curl_close($ch);

        if ($curlError) {
            return;
        }

        if ($httpCode !== 200) {
            return;
        }

        $result = json_decode($response, true);
        
        if (!$result['ok']) {
            echo "‚ùå Telegram API ÈîôËØØ: " . ($result['description'] ?? 'Unknown error') . "\n";
            return;
        }

        $webhookInfo = $result['result'];

        echo "‚úÖ Telegram Webhook ‰ø°ÊÅØËé∑ÂèñÊàêÂäü:\n";
        echo "   üìç URL: " . ($webhookInfo['url'] ?? 'Êú™ËÆæÁΩÆ') . "\n";
        echo "   üî¢ ÂæÖÂ§ÑÁêÜÊõ¥Êñ∞Êï∞: " . ($webhookInfo['pending_update_count'] ?? 0) . "\n";
        echo "   üåê ÊúÄÂêéÈîôËØØÊó•Êúü: " . ($webhookInfo['last_error_date'] ?? 'Êó†') . "\n";
        echo "   ‚ùå ÊúÄÂêéÈîôËØØÊ∂àÊÅØ: " . ($webhookInfo['last_error_message'] ?? 'Êó†') . "\n";
        echo "   üîÑ ÊúÄÂ§ßËøûÊé•Êï∞: " . ($webhookInfo['max_connections'] ?? 'Êú™ËÆæÁΩÆ') . "\n";
        echo "   üìã ÂÖÅËÆ∏ÁöÑÊõ¥Êñ∞Á±ªÂûã: " . json_encode($webhookInfo['allowed_updates'] ?? []) . "\n";
        echo "   üìã Êú∫Âô®‰∫∫ÈöêÁßÅÊ®°ÂºèÈúÄË¶ÅÂÖ≥Èó≠\n";

        // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØ
        if (!empty($webhookInfo['last_error_message'])) {
            echo "‚ö†Ô∏è  Ë≠¶Âëä: Webhook Â≠òÂú®ÈîôËØØÔºåËØ∑Ê£ÄÊü•ÈÖçÁΩÆ\n";
        }
        
        // Ê£ÄÊü• URL ÊòØÂê¶ÊåáÂêëÂΩìÂâçÊúçÂä°Âô®
        $currentUrl = env('TELEGRAM_WEBHOOK');
//        if (isset($webhookInfo['url']) && $webhookInfo['url'] !== $currentUrl) {

            if (setTelegramWebhook($botToken, $currentUrl)) {
                echo "‚úÖ Webhook ËÆæÁΩÆÊàêÂäü\n";
            } else {
                echo "‚ùå Webhook ËÆæÁΩÆÂ§±Ë¥•\n";
            }
//        }
        
        echo "\n";

    } catch (\Exception $e) {
        echo "‚ùå Ê£ÄÊü• Telegram Webhook Êó∂ÂèëÁîüÂºÇÂ∏∏: " . $e->getMessage() . "\n";
    }
}

/**
 * Ëá™Âä®ÈÖçÁΩÆ Telegram
 * @return bool
 */
function autoConfigureTelegram(): bool
{
    try {
        // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú® .env Êñá‰ª∂
        $envFile = __DIR__ . '/.env';
        if (!file_exists($envFile)) {
            echo "‚ùå .env Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏≠...\n";
            createEnvFile();
        }

        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÈÖçÁΩÆ
        $envContent = file_get_contents($envFile);
        if (strpos($envContent, 'TELEGRAM_BOT_TOKEN') !== false) {
            echo "‚ÑπÔ∏è  .env Êñá‰ª∂‰∏≠Â∑≤Â≠òÂú® Telegram ÈÖçÁΩÆ\n";
            return true;
        }

        // Â∞ùËØï‰ªéÁéØÂ¢ÉÂèòÈáèËé∑Âèñ
        $botToken = getenv('TELEGRAM_BOT_TOKEN');
        if (!empty($botToken)) {
            echo "‚úÖ ‰ªéÁéØÂ¢ÉÂèòÈáèËé∑ÂèñÂà∞ Bot Token\n";
            addTelegramConfigToEnv($botToken);
            return true;
        }

        // Â∞ùËØï‰ªéÁî®Êà∑ËæìÂÖ•Ëé∑Âèñ
        echo "ËØ∑ËæìÂÖ•ÊÇ®ÁöÑ Telegram Bot Token (Ê†ºÂºè: 123456789:ABCdefGHIjklMNOpqrsTUVwxyz):\n";
        echo "> ";
        
        // Âú®Èùû‰∫§‰∫íÊ®°Âºè‰∏ãÔºåË∑≥ËøáÁî®Êà∑ËæìÂÖ•
        if (!posix_isatty(STDIN)) {
            echo "‚ùå Èùû‰∫§‰∫íÊ®°ÂºèÔºåÊó†Ê≥ïËé∑ÂèñÁî®Êà∑ËæìÂÖ•\n";
            showConfigurationGuide();
            return false;
        }

        $input = trim(fgets(STDIN));
        
        if (empty($input)) {
            echo "‚ùå Êú™ËæìÂÖ• Bot Token\n";
            showConfigurationGuide();
            return false;
        }

        // È™åËØÅ Token Ê†ºÂºè
        if (!preg_match('/^\d+:[A-Za-z0-9_-]+$/', $input)) {
            echo "‚ùå Bot Token Ê†ºÂºèÊó†Êïà\n";
            showConfigurationGuide();
            return false;
        }

        // È™åËØÅ Token ÊúâÊïàÊÄß
        if (validateBotToken($input)) {
            echo "‚úÖ Bot Token È™åËØÅÊàêÂäü\n";
            addTelegramConfigToEnv($input);
            return true;
        } else {
            echo "‚ùå Bot Token È™åËØÅÂ§±Ë¥•\n";
            showConfigurationGuide();
            return false;
        }

    } catch (\Exception $e) {
        echo "‚ùå Ëá™Âä®ÈÖçÁΩÆÂºÇÂ∏∏: " . $e->getMessage() . "\n";
        return false;
    }
}

/**
 * ÂàõÂª∫ .env Êñá‰ª∂
 */
function createEnvFile(): void
{
    $envContent = "# Telegram Bot ÈÖçÁΩÆ\n";
    $envContent .= "TELEGRAM_BOT_TOKEN=\n";
    $envContent .= "TELEGRAM_DEFAULT_CHAT_ID=\n";
    $envContent .= "TELEGRAM_NOTIFICATION_ENABLED=true\n";
    $envContent .= "TELEGRAM_ALLOWED_IPS=149.154.167.197,149.154.167.198,149.154.167.199,149.154.167.200,149.154.167.201,149.154.167.202,149.154.167.203,149.154.167.204,149.154.167.205,149.154.167.206,149.154.167.207,149.154.167.208,149.154.167.209,149.154.167.210,149.154.167.211,149.154.167.212,149.154.167.213,149.154.167.214,149.154.167.215,149.154.167.216,149.154.167.217,149.154.167.218,149.154.167.219,149.154.167.220,149.154.167.221,149.154.167.222,149.154.167.223,149.154.167.224,149.154.167.225,149.154.167.226,149.154.167.227,149.154.167.228,149.154.167.229,149.154.167.230,149.154.167.231,149.154.167.232,149.154.167.233,149.154.167.234,149.154.167.235,149.154.167.236,149.154.167.237,149.154.167.238,149.154.167.239,149.154.167.240,149.154.167.241,149.154.167.242,149.154.167.243,149.154.167.244,149.154.167.245,149.154.167.246,149.154.167.247,149.154.167.248,149.154.167.249,149.154.167.250,149.154.167.251,149.154.167.252,149.154.167.253,149.154.167.254,149.154.167.255,91.108.4.0/22,91.108.8.0/22,91.108.12.0/22,91.108.16.0/22,91.108.20.0/22,91.108.24.0/22,91.108.28.0/22,91.108.32.0/22,91.108.36.0/22,91.108.40.0/22,91.108.44.0/22,91.108.48.0/22,91.108.52.0/22,91.108.56.0/22,91.108.60.0/22,91.108.64.0/22,91.108.68.0/22,91.108.72.0/22,91.108.76.0/22,91.108.80.0/22,91.108.84.0/22,91.108.88.0/22,91.108.92.0/22,91.108.96.0/22,91.108.100.0/22,91.108.104.0/22,91.108.108.0/22,91.108.112.0/22,91.108.116.0/22,91.108.120.0/22,91.108.124.0/22,91.108.128.0/22,91.108.132.0/22,91.108.136.0/22,91.108.140.0/22,91.108.144.0/22,91.108.148.0/22,91.108.152.0/22,91.108.156.0/22,91.108.160.0/22,91.108.164.0/22,91.108.168.0/22,91.108.172.0/22,91.108.176.0/22,91.108.180.0/22,91.108.184.0/22,91.108.188.0/22,91.108.192.0/22,91.108.196.0/22,91.108.200.0/22,91.108.204.0/22,91.108.208.0/22,91.108.212.0/22,91.108.216.0/22,91.108.220.0/22,91.108.224.0/22,91.108.228.0/22,91.108.232.0/22,91.108.236.0/22,91.108.240.0/22,91.108.244.0/22,91.108.248.0/22,91.108.252.0/22\n";
    
    file_put_contents(__DIR__ . '/.env', $envContent);
    echo "‚úÖ .env Êñá‰ª∂ÂàõÂª∫ÊàêÂäü\n";
}

/**
 * Ê∑ªÂä† Telegram ÈÖçÁΩÆÂà∞ .env Êñá‰ª∂
 * @param string $botToken
 */
function addTelegramConfigToEnv(string $botToken): void
{
    $envFile = __DIR__ . '/.env';
    $envContent = file_get_contents($envFile);
    
    // ÊõøÊç¢ÊàñÊ∑ªÂä†ÈÖçÁΩÆ
    if (strpos($envContent, 'TELEGRAM_BOT_TOKEN=') !== false) {
        $envContent = preg_replace('/TELEGRAM_BOT_TOKEN=.*/', "TELEGRAM_BOT_TOKEN={$botToken}", $envContent);
    } else {
        $envContent .= "\nTELEGRAM_BOT_TOKEN={$botToken}\n";
    }
    
    file_put_contents($envFile, $envContent);
    echo "‚úÖ Telegram ÈÖçÁΩÆÂ∑≤Ê∑ªÂä†Âà∞ .env Êñá‰ª∂\n";
}

/**
 * È™åËØÅ Bot Token
 * @param string $botToken
 * @return bool
 */
function validateBotToken(string $botToken): bool
{
    try {
        $apiUrl = "https://api.telegram.org/bot{$botToken}/getMe";
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $apiUrl);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        if ($httpCode !== 200) {
            return false;
        }
        
        $result = json_decode($response, true);
        return $result['ok'] ?? false;
        
    } catch (\Exception $e) {
        return false;
    }
}

/**
 * ËÆæÁΩÆ Telegram Webhook
 * @param string $botToken
 * @param string $webhookUrl
 * @return bool
 */
function setTelegramWebhook(string $botToken, string $webhookUrl): bool
{
    try {
        $apiUrl = "https://api.telegram.org/bot{$botToken}/setWebhook";
        
        $data = [
            'url' => $webhookUrl,
            'allowed_updates' => json_encode(['message'])
        ];
        
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $apiUrl);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);
        
        if ($httpCode !== 200) {
            return false;
        }
        
        $result = json_decode($response, true);
        return $result['ok'] ?? false;
        
    } catch (\Exception $e) {
        return false;
    }
}

/**
 * ÊòæÁ§∫ÈÖçÁΩÆÊåáÂçó
 */
function showConfigurationGuide(): void
{
    echo "\nüìñ Telegram Bot ÈÖçÁΩÆÊåáÂçó:\n";
    echo "1. Âú® Telegram ‰∏≠ÊêúÁ¥¢ @BotFather\n";
    echo "2. ÂèëÈÄÅ /newbot ÂëΩ‰ª§\n";
    echo "3. ÊåâÊèêÁ§∫ËÆæÁΩÆÊú∫Âô®‰∫∫ÂêçÁß∞ÂíåÁî®Êà∑Âêç\n";
    echo "4. Ëé∑Âèñ Token Âπ∂ÈÖçÁΩÆÂà∞ .env Êñá‰ª∂‰∏≠\n\n";
    echo "ÈÖçÁΩÆÁ§∫‰æã:\n";
    echo "TELEGRAM_BOT_TOKEN=your_actual_bot_token_here\n";
    echo "TELEGRAM_DEFAULT_CHAT_ID=your_chat_id_here\n";
    echo "TELEGRAM_NOTIFICATION_ENABLED=true\n\n";
    echo "ËÆæÁΩÆ Webhook ÁöÑÂëΩ‰ª§:\n";
    echo "curl -X POST \"https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook\" \\\n";
    echo "     -d \"url=http://mclient.dev.alipay.lu:8081/telegram/webhook\"\n\n";
}
