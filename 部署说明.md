# 三方支付系统部署说明

## 📋 目录
- [首次部署步骤](#首次部署步骤)
- [服务器环境准备](#服务器环境准备)
- [代码部署](#代码部署)
- [服务配置](#服务配置)
- [系统ctl服务安装](#systemctl服务安装)
- [部署验证](#部署验证)
- [日常部署更新](#日常部署更新)
- [故障排除](#故障排除)

## 🚀 首次部署步骤

### 1. 环境检查

#### 1.1 系统要求
- **操作系统**: Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- **PHP版本**: PHP 8.0 或更高版本 (已安装)
- **内存**: 建议 2GB 以上
- **磁盘**: 建议 20GB 以上

#### 1.2 环境检查
```bash
# 检查PHP版本
php -v

# 检查项目目录
ls -la /www/api.gflzt.cn

# 检查网络连通性
ping 10.170.0.4
telnet 10.170.0.4 3306
telnet 10.170.0.4 6379
```

#### 1.3 数据库和Redis配置信息
- **MySQL服务器**: 10.170.0.4:3306
- **Redis服务器**: 10.170.0.4:6379
- **Redis密码**: aZ8^pR3#kH5!tW9v2L@

### 2. 快速部署

#### 2.1 执行自动部署脚本
```bash
# 下载并执行部署脚本
chmod +x 首次部署.sh
sudo ./首次部署.sh
```

#### 2.2 手动部署（可选）
如果自动部署脚本执行失败，可以手动执行以下步骤：

```bash
# 切换到项目目录
cd /www/api.gflzt.cn

# 更新代码（如果已有代码）
sudo -u www-data git pull origin main

# 安装PHP依赖
sudo -u www-data composer install --no-dev --optimize-autoloader
```

#### 2.3 配置环境
```bash
# 创建数据库配置文件
sudo -u www-data tee config/database.php > /dev/null << 'EOF'
<?php
return [
    'default' => 'mysql',
    'connections' => [
        'mysql' => [
            'driver' => 'mysql',
            'host' => '10.170.0.4',
            'port' => 3306,
            'database' => 'fourth_party_payment',
            'username' => 'fourth_party_payment',
            'password' => 'q7esCgVO{9},.JGA',
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
            'prefix' => 'fourth_party_payment_',
            'strict' => false,
            'engine' => null,
        ],
    ],
];
EOF

# 创建Redis配置文件
sudo -u www-data tee config/redis.php > /dev/null << 'EOF'
<?php
return [
    'default' => 'redis',
    'connections' => [
        'redis' => [
            'host' => '10.170.0.4',
            'port' => 6379,
            'password' => 'aZ8^pR3#kH5!tW9v2L@',
            'database' => 0,
        ],
    ],
];
EOF
```

### 3. 数据库配置

#### 3.1 数据库连接信息
- **数据库服务器**: 10.170.0.4:3306
- **数据库名称**: fourth_party_payment
- **用户名**: payment_user
- **密码**: your_password (请替换为实际密码)

#### 3.2 数据库结构说明
数据库结构已在远程数据库服务器(10.170.0.4)上配置完成，无需导入。

### 4. 服务配置

#### 4.1 安装systemctl服务
```bash
# 复制服务配置文件
sudo cp webman.service /etc/systemd/system/payment-service.service

# 重新加载systemd配置
sudo systemctl daemon-reload

# 启用服务
sudo systemctl enable payment-service
```

#### 4.2 配置Nginx
```bash
# 创建Nginx配置文件
sudo nano /etc/nginx/sites-available/api.gflzt.cn

# 配置内容：
server {
    listen 80;
    server_name api.gflzt.cn;
    root /www/api.gflzt.cn/public;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.ht {
        deny all;
    }
}

# 启用站点
sudo ln -s /etc/nginx/sites-available/api.gflzt.cn /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 5. 启动服务

#### 5.1 启动三方支付服务
```bash
# 启动服务
sudo systemctl start payment-service

# 检查服务状态
sudo systemctl status payment-service

# 查看服务日志
sudo journalctl -u payment-service -f
```

#### 5.2 验证服务运行
```bash
# 检查端口监听
sudo netstat -tlnp | grep :8787

# 测试HTTP响应
curl http://localhost:8787

# 检查进程
ps aux | grep "php.*start.php"
```

### 6. 部署验证

#### 6.1 使用状态检测脚本
```bash
# 给脚本添加执行权限
chmod +x check_server_status.sh

# 检查单个服务器
./check_server_status.sh single "本地服务器" "127.0.0.1" 8787

# 批量检查服务器（需要创建服务器列表文件）
echo "本地服务器,127.0.0.1,8787" > servers.txt
./check_server_status.sh batch servers.txt
```

#### 6.2 访问管理界面
- 打开浏览器访问: `http://api.gflzt.cn`
- 登录管理后台
- 检查服务器管理功能
- 测试部署功能

## 🔄 日常部署更新

### 1. 通过管理界面部署

#### 1.1 使用部署功能
1. 登录管理后台
2. 进入"运维管理" → "服务器管理"
3. 点击"部署"按钮
4. 选择部署模式：
   - **更新并重启**: 拉取最新代码并重启服务
   - **只更新**: 仅拉取最新代码，不重启服务
5. 选择目标服务器
6. 填写部署说明
7. 点击"开始部署"
8. 下载生成的部署脚本
9. 在服务器上执行脚本

#### 1.2 手动执行部署脚本
```bash
# 在服务器上执行生成的部署脚本
chmod +x deploy_20241214_143022.sh
./deploy_20241214_143022.sh
```

### 2. 手动部署更新

#### 2.1 更新代码
```bash
# 进入项目目录
cd /www/api.gflzt.cn

# 拉取最新代码
sudo -u www-data git pull origin develop

# 更新依赖
sudo -u www-data composer install --no-dev --optimize-autoloader
```

#### 2.2 重启服务
```bash
# 重启三方支付服务
sudo systemctl restart payment-service

# 检查服务状态
sudo systemctl status payment-service
```

## 🛠️ 故障排除

### 1. 服务启动失败

#### 1.1 检查服务状态
```bash
# 查看服务状态
sudo systemctl status payment-service

# 查看详细日志
sudo journalctl -u payment-service -n 50
```

#### 1.2 常见问题
- **权限问题**: 检查目录权限 `sudo chown -R www-data:www-data /www/api.gflzt.cn`
- **PHP版本问题**: 确认PHP版本 `php -v`
- **端口占用**: 检查端口 `sudo netstat -tlnp | grep :8787`

### 2. 数据库连接问题

#### 2.1 检查数据库配置
```bash
# 测试数据库连接
cd /www/api.gflzt.cn
php -r "
try {
    \$pdo = new PDO('mysql:host=localhost;dbname=fourth_party_payment', 'payment_user', 'your_password');
    echo '数据库连接成功\n';
} catch (Exception \$e) {
    echo '数据库连接失败: ' . \$e->getMessage() . '\n';
}
"
```

### 3. Redis连接问题

#### 3.1 检查Redis服务
```bash
# 检查Redis状态
sudo systemctl status redis

# 测试Redis连接
redis-cli ping
```

### 4. 网络问题

#### 4.1 检查防火墙
```bash
# Ubuntu/Debian
sudo ufw status
sudo ufw allow 8787

# CentOS/RHEL
sudo firewall-cmd --list-ports
sudo firewall-cmd --add-port=8787/tcp --permanent
sudo firewall-cmd --reload
```

## 📞 技术支持

### 1. 日志文件位置
- **服务日志**: `sudo journalctl -u payment-service -f`
- **应用日志**: `/www/api.gflzt.cn/backend-api/runtime/logs/`
- **Nginx日志**: `/var/log/nginx/`

### 2. 常用命令
```bash
# 服务管理
sudo systemctl start payment-service    # 启动服务
sudo systemctl stop payment-service     # 停止服务
sudo systemctl restart payment-service  # 重启服务
sudo systemctl status payment-service   # 查看状态

# 日志查看
sudo journalctl -u payment-service -f   # 实时查看日志
sudo journalctl -u payment-service -n 100 # 查看最近100条日志

# 进程管理
ps aux | grep "php.*start.php"          # 查看webman进程
sudo kill -9 <PID>                      # 强制杀死进程
```

### 3. 监控脚本
使用 `check_server_status.sh` 脚本定期检查服务器状态：
```bash
# 添加到crontab定期检查
echo "*/5 * * * * /www/api.gflzt.cn/check_server_status.sh single '本地服务器' '127.0.0.1' 8787" | sudo crontab -
```

## ✅ 部署检查清单

- [ ] 服务器环境准备完成
- [ ] 代码仓库克隆成功
- [ ] 数据库配置正确
- [ ] Redis服务运行正常
- [ ] systemctl服务安装成功
- [ ] Nginx配置正确
- [ ] 服务启动成功
- [ ] 端口监听正常
- [ ] HTTP响应正常
- [ ] 管理界面可访问
- [ ] 部署功能测试通过

---

**注意**: 首次部署请按照步骤顺序执行，确保每个步骤都成功完成后再进行下一步。如有问题，请查看相应的日志文件进行排查。
