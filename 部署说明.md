# ä¸‰æ–¹æ”¯ä»˜ç³»ç»Ÿéƒ¨ç½²è¯´æ˜

## ğŸ“‹ ç›®å½•
- [é¦–æ¬¡éƒ¨ç½²æ­¥éª¤](#é¦–æ¬¡éƒ¨ç½²æ­¥éª¤)
- [æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡](#æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡)
- [ä»£ç éƒ¨ç½²](#ä»£ç éƒ¨ç½²)
- [æœåŠ¡é…ç½®](#æœåŠ¡é…ç½®)
- [ç³»ç»ŸctlæœåŠ¡å®‰è£…](#systemctlæœåŠ¡å®‰è£…)
- [éƒ¨ç½²éªŒè¯](#éƒ¨ç½²éªŒè¯)
- [æ—¥å¸¸éƒ¨ç½²æ›´æ–°](#æ—¥å¸¸éƒ¨ç½²æ›´æ–°)
- [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

## ğŸš€ é¦–æ¬¡éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒæ£€æŸ¥

#### 1.1 ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- **PHPç‰ˆæœ¬**: PHP 8.0 æˆ–æ›´é«˜ç‰ˆæœ¬ (å·²å®‰è£…)
- **å†…å­˜**: å»ºè®® 2GB ä»¥ä¸Š
- **ç£ç›˜**: å»ºè®® 20GB ä»¥ä¸Š

#### 1.2 ç¯å¢ƒæ£€æŸ¥
```bash
# æ£€æŸ¥PHPç‰ˆæœ¬
php -v

# æ£€æŸ¥é¡¹ç›®ç›®å½•
ls -la /www/api.gflzt.cn

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping 10.170.0.4
telnet 10.170.0.4 3306
telnet 10.170.0.4 6379
```

#### 1.3 æ•°æ®åº“å’ŒRedisé…ç½®ä¿¡æ¯
- **MySQLæœåŠ¡å™¨**: 10.170.0.4:3306
- **RedisæœåŠ¡å™¨**: 10.170.0.4:6379
- **Rediså¯†ç **: aZ8^pR3#kH5!tW9v2L@

### 2. å¿«é€Ÿéƒ¨ç½²

#### 2.1 æ‰§è¡Œè‡ªåŠ¨éƒ¨ç½²è„šæœ¬
```bash
# ä¸‹è½½å¹¶æ‰§è¡Œéƒ¨ç½²è„šæœ¬
chmod +x é¦–æ¬¡éƒ¨ç½².sh
sudo ./é¦–æ¬¡éƒ¨ç½².sh
```

#### 2.2 æ‰‹åŠ¨éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰
å¦‚æœè‡ªåŠ¨éƒ¨ç½²è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

```bash
# åˆ‡æ¢åˆ°é¡¹ç›®ç›®å½•
cd /www/api.gflzt.cn

# æ›´æ–°ä»£ç ï¼ˆå¦‚æœå·²æœ‰ä»£ç ï¼‰
sudo -u www-data git pull origin main

# å®‰è£…PHPä¾èµ–
sudo -u www-data composer install --no-dev --optimize-autoloader
```

#### 2.3 é…ç½®ç¯å¢ƒ
```bash
# åˆ›å»ºæ•°æ®åº“é…ç½®æ–‡ä»¶
sudo -u www-data tee config/database.php > /dev/null << 'EOF'
<?php
return [
    'default' => 'mysql',
    'connections' => [
        'mysql' => [
            'driver' => 'mysql',
            'host' => '10.170.0.4',
            'port' => 3306,
            'database' => 'fourth_party_payment',
            'username' => 'fourth_party_payment',
            'password' => 'q7esCgVO{9},.JGA',
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
            'prefix' => 'fourth_party_payment_',
            'strict' => false,
            'engine' => null,
        ],
    ],
];
EOF

# åˆ›å»ºRedisé…ç½®æ–‡ä»¶
sudo -u www-data tee config/redis.php > /dev/null << 'EOF'
<?php
return [
    'default' => 'redis',
    'connections' => [
        'redis' => [
            'host' => '10.170.0.4',
            'port' => 6379,
            'password' => 'aZ8^pR3#kH5!tW9v2L@',
            'database' => 0,
        ],
    ],
];
EOF
```

### 3. æ•°æ®åº“é…ç½®

#### 3.1 æ•°æ®åº“è¿æ¥ä¿¡æ¯
- **æ•°æ®åº“æœåŠ¡å™¨**: 10.170.0.4:3306
- **æ•°æ®åº“åç§°**: fourth_party_payment
- **ç”¨æˆ·å**: payment_user
- **å¯†ç **: your_password (è¯·æ›¿æ¢ä¸ºå®é™…å¯†ç )

#### 3.2 æ•°æ®åº“ç»“æ„è¯´æ˜
æ•°æ®åº“ç»“æ„å·²åœ¨è¿œç¨‹æ•°æ®åº“æœåŠ¡å™¨(10.170.0.4)ä¸Šé…ç½®å®Œæˆï¼Œæ— éœ€å¯¼å…¥ã€‚

### 4. æœåŠ¡é…ç½®

#### 4.1 å®‰è£…systemctlæœåŠ¡
```bash
# å¤åˆ¶æœåŠ¡é…ç½®æ–‡ä»¶
sudo cp webman.service /etc/systemd/system/payment-service.service

# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯ç”¨æœåŠ¡
sudo systemctl enable payment-service
```

#### 4.2 é…ç½®Nginx
```bash
# åˆ›å»ºNginxé…ç½®æ–‡ä»¶
sudo nano /etc/nginx/sites-available/api.gflzt.cn

# é…ç½®å†…å®¹ï¼š
server {
    listen 80;
    server_name api.gflzt.cn;
    root /www/api.gflzt.cn/public;
    index index.php;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.ht {
        deny all;
    }
}

# å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/api.gflzt.cn /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 5. å¯åŠ¨æœåŠ¡

#### 5.1 å¯åŠ¨ä¸‰æ–¹æ”¯ä»˜æœåŠ¡
```bash
# å¯åŠ¨æœåŠ¡
sudo systemctl start payment-service

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status payment-service

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u payment-service -f
```

#### 5.2 éªŒè¯æœåŠ¡è¿è¡Œ
```bash
# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep :8787

# æµ‹è¯•HTTPå“åº”
curl http://localhost:8787

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep "php.*start.php"
```

### 6. éƒ¨ç½²éªŒè¯

#### 6.1 ä½¿ç”¨çŠ¶æ€æ£€æµ‹è„šæœ¬
```bash
# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x check_server_status.sh

# æ£€æŸ¥å•ä¸ªæœåŠ¡å™¨
./check_server_status.sh single "æœ¬åœ°æœåŠ¡å™¨" "127.0.0.1" 8787

# æ‰¹é‡æ£€æŸ¥æœåŠ¡å™¨ï¼ˆéœ€è¦åˆ›å»ºæœåŠ¡å™¨åˆ—è¡¨æ–‡ä»¶ï¼‰
echo "æœ¬åœ°æœåŠ¡å™¨,127.0.0.1,8787" > servers.txt
./check_server_status.sh batch servers.txt
```

#### 6.2 è®¿é—®ç®¡ç†ç•Œé¢
- æ‰“å¼€æµè§ˆå™¨è®¿é—®: `http://api.gflzt.cn`
- ç™»å½•ç®¡ç†åå°
- æ£€æŸ¥æœåŠ¡å™¨ç®¡ç†åŠŸèƒ½
- æµ‹è¯•éƒ¨ç½²åŠŸèƒ½

## ğŸ”„ æ—¥å¸¸éƒ¨ç½²æ›´æ–°

### 1. é€šè¿‡ç®¡ç†ç•Œé¢éƒ¨ç½²

#### 1.1 ä½¿ç”¨éƒ¨ç½²åŠŸèƒ½
1. ç™»å½•ç®¡ç†åå°
2. è¿›å…¥"è¿ç»´ç®¡ç†" â†’ "æœåŠ¡å™¨ç®¡ç†"
3. ç‚¹å‡»"éƒ¨ç½²"æŒ‰é’®
4. é€‰æ‹©éƒ¨ç½²æ¨¡å¼ï¼š
   - **æ›´æ–°å¹¶é‡å¯**: æ‹‰å–æœ€æ–°ä»£ç å¹¶é‡å¯æœåŠ¡
   - **åªæ›´æ–°**: ä»…æ‹‰å–æœ€æ–°ä»£ç ï¼Œä¸é‡å¯æœåŠ¡
5. é€‰æ‹©ç›®æ ‡æœåŠ¡å™¨
6. å¡«å†™éƒ¨ç½²è¯´æ˜
7. ç‚¹å‡»"å¼€å§‹éƒ¨ç½²"
8. ä¸‹è½½ç”Ÿæˆçš„éƒ¨ç½²è„šæœ¬
9. åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œè„šæœ¬

#### 1.2 æ‰‹åŠ¨æ‰§è¡Œéƒ¨ç½²è„šæœ¬
```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œç”Ÿæˆçš„éƒ¨ç½²è„šæœ¬
chmod +x deploy_20241214_143022.sh
./deploy_20241214_143022.sh
```

### 2. æ‰‹åŠ¨éƒ¨ç½²æ›´æ–°

#### 2.1 æ›´æ–°ä»£ç 
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/api.gflzt.cn

# æ‹‰å–æœ€æ–°ä»£ç 
sudo -u www-data git pull origin develop

# æ›´æ–°ä¾èµ–
sudo -u www-data composer install --no-dev --optimize-autoloader
```

#### 2.2 é‡å¯æœåŠ¡
```bash
# é‡å¯ä¸‰æ–¹æ”¯ä»˜æœåŠ¡
sudo systemctl restart payment-service

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status payment-service
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### 1. æœåŠ¡å¯åŠ¨å¤±è´¥

#### 1.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
sudo systemctl status payment-service

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
sudo journalctl -u payment-service -n 50
```

#### 1.2 å¸¸è§é—®é¢˜
- **æƒé™é—®é¢˜**: æ£€æŸ¥ç›®å½•æƒé™ `sudo chown -R www-data:www-data /www/api.gflzt.cn`
- **PHPç‰ˆæœ¬é—®é¢˜**: ç¡®è®¤PHPç‰ˆæœ¬ `php -v`
- **ç«¯å£å ç”¨**: æ£€æŸ¥ç«¯å£ `sudo netstat -tlnp | grep :8787`

### 2. æ•°æ®åº“è¿æ¥é—®é¢˜

#### 2.1 æ£€æŸ¥æ•°æ®åº“é…ç½®
```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
cd /www/api.gflzt.cn
php -r "
try {
    \$pdo = new PDO('mysql:host=localhost;dbname=fourth_party_payment', 'payment_user', 'your_password');
    echo 'æ•°æ®åº“è¿æ¥æˆåŠŸ\n';
} catch (Exception \$e) {
    echo 'æ•°æ®åº“è¿æ¥å¤±è´¥: ' . \$e->getMessage() . '\n';
}
"
```

### 3. Redisè¿æ¥é—®é¢˜

#### 3.1 æ£€æŸ¥RedisæœåŠ¡
```bash
# æ£€æŸ¥RedisçŠ¶æ€
sudo systemctl status redis

# æµ‹è¯•Redisè¿æ¥
redis-cli ping
```

### 4. ç½‘ç»œé—®é¢˜

#### 4.1 æ£€æŸ¥é˜²ç«å¢™
```bash
# Ubuntu/Debian
sudo ufw status
sudo ufw allow 8787

# CentOS/RHEL
sudo firewall-cmd --list-ports
sudo firewall-cmd --add-port=8787/tcp --permanent
sudo firewall-cmd --reload
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### 1. æ—¥å¿—æ–‡ä»¶ä½ç½®
- **æœåŠ¡æ—¥å¿—**: `sudo journalctl -u payment-service -f`
- **åº”ç”¨æ—¥å¿—**: `/www/api.gflzt.cn/backend-api/runtime/logs/`
- **Nginxæ—¥å¿—**: `/var/log/nginx/`

### 2. å¸¸ç”¨å‘½ä»¤
```bash
# æœåŠ¡ç®¡ç†
sudo systemctl start payment-service    # å¯åŠ¨æœåŠ¡
sudo systemctl stop payment-service     # åœæ­¢æœåŠ¡
sudo systemctl restart payment-service  # é‡å¯æœåŠ¡
sudo systemctl status payment-service   # æŸ¥çœ‹çŠ¶æ€

# æ—¥å¿—æŸ¥çœ‹
sudo journalctl -u payment-service -f   # å®æ—¶æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u payment-service -n 100 # æŸ¥çœ‹æœ€è¿‘100æ¡æ—¥å¿—

# è¿›ç¨‹ç®¡ç†
ps aux | grep "php.*start.php"          # æŸ¥çœ‹webmanè¿›ç¨‹
sudo kill -9 <PID>                      # å¼ºåˆ¶æ€æ­»è¿›ç¨‹
```

### 3. ç›‘æ§è„šæœ¬
ä½¿ç”¨ `check_server_status.sh` è„šæœ¬å®šæœŸæ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€ï¼š
```bash
# æ·»åŠ åˆ°crontabå®šæœŸæ£€æŸ¥
echo "*/5 * * * * /www/api.gflzt.cn/check_server_status.sh single 'æœ¬åœ°æœåŠ¡å™¨' '127.0.0.1' 8787" | sudo crontab -
```

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡å®Œæˆ
- [ ] ä»£ç ä»“åº“å…‹éš†æˆåŠŸ
- [ ] æ•°æ®åº“é…ç½®æ­£ç¡®
- [ ] RedisæœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] systemctlæœåŠ¡å®‰è£…æˆåŠŸ
- [ ] Nginxé…ç½®æ­£ç¡®
- [ ] æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] ç«¯å£ç›‘å¬æ­£å¸¸
- [ ] HTTPå“åº”æ­£å¸¸
- [ ] ç®¡ç†ç•Œé¢å¯è®¿é—®
- [ ] éƒ¨ç½²åŠŸèƒ½æµ‹è¯•é€šè¿‡

---

**æ³¨æ„**: é¦–æ¬¡éƒ¨ç½²è¯·æŒ‰ç…§æ­¥éª¤é¡ºåºæ‰§è¡Œï¼Œç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½æˆåŠŸå®Œæˆåå†è¿›è¡Œä¸‹ä¸€æ­¥ã€‚å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ç›¸åº”çš„æ—¥å¿—æ–‡ä»¶è¿›è¡Œæ’æŸ¥ã€‚
