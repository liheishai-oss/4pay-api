# 商户回调监控面板

## 功能概述

商户回调监控面板是一个实时监控系统，用于监控商户回调的状态、性能和健康情况。它提供了全面的监控数据、商户状态统计、系统健康检查等功能。

## 主要功能

### 1. 实时监控数据
- **通知统计**: 显示最近1小时的通知总数、成功数、失败数和成功率
- **队列状态**: 实时显示重试队列、延迟队列、熔断商户数量
- **最近日志**: 显示最近10条通知日志记录

### 2. 商户状态统计
- **商户概览**: 显示总商户数、正常商户、慢响应商户、熔断商户数量
- **商户列表**: 详细显示每个商户的状态、失败次数、平均响应时间
- **状态管理**: 支持重置商户熔断器、查看商户详情

### 3. 系统健康状态
- **组件监控**: 监控Redis、数据库、队列、通知服务的健康状态
- **整体状态**: 显示系统整体健康状态
- **实时刷新**: 支持手动刷新和自动刷新

### 4. 通知日志管理
- **日志查询**: 支持按订单号、状态、商户、时间范围查询
- **详细信息**: 显示HTTP状态码、重试次数、响应数据等
- **分页显示**: 支持分页浏览大量日志数据

## 技术架构

### 后端组件

#### 1. 控制器层
- **MerchantCallbackMonitorController**: 处理所有监控相关的HTTP请求
  - `getRealTimeData()`: 获取实时监控数据
  - `getMerchantStats()`: 获取商户状态统计
  - `getNotifyLogs()`: 获取通知日志列表
  - `getMerchantDetail()`: 获取商户详情
  - `resetMerchantCircuitBreaker()`: 重置商户熔断器
  - `triggerMerchantNotify()`: 手动触发商户通知
  - `getSystemHealth()`: 获取系统健康状态

#### 2. 服务层
- **MerchantCallbackMonitorService**: 核心业务逻辑处理
  - 实时数据聚合和计算
  - 商户状态分析和统计
  - 系统健康检查
  - 熔断器管理
  - 通知触发

#### 3. 数据层
- **NotifyLog模型**: 通知日志数据模型
- **Order模型**: 订单数据模型
- **Redis**: 缓存和队列数据
- **MySQL**: 持久化数据存储

### 前端组件

#### 1. 页面组件
- **callback.vue**: 主监控页面
  - 实时数据展示
  - 商户状态管理
  - 系统健康监控
  - 自动刷新控制

#### 2. 功能特性
- **响应式设计**: 适配不同屏幕尺寸
- **实时更新**: 支持自动刷新（5秒-1分钟可配置）
- **交互操作**: 支持重置熔断器、查看详情等操作
- **数据可视化**: 使用卡片、表格、标签等组件展示数据

## 部署说明

### 1. 后端部署

#### 安装依赖
确保已安装以下PHP扩展：
- Redis
- MySQL/PDO
- JSON
- cURL

#### 配置要求
- **Redis配置**: 确保Redis服务正常运行
- **数据库配置**: 确保MySQL连接正常
- **权限配置**: 执行权限SQL脚本

#### 执行权限脚本
```bash
mysql -u username -p database_name < insert_monitor_permissions.sql
```

### 2. 前端部署

#### 环境要求
- Node.js 16+
- Vue 3
- Element Plus
- Vite

#### 构建部署
```bash
cd admin-frontend
npm install
npm run build
```

### 3. 路由配置

#### 后端路由
监控相关路由已自动注册到 `/admin/monitor/callback/*`

#### 前端路由
监控页面路由: `/monitor/callback`

## 权限配置

### 权限列表

| 权限标识 | 权限名称 | 描述 |
|---------|---------|------|
| `monitor:home` | 监控管理 | 监控管理模块入口 |
| `monitor:callback` | 商户回调监控 | 商户回调监控页面 |
| `monitor:callback:real-time` | 实时监控数据 | 查看实时监控数据 |
| `monitor:callback:merchant-stats` | 商户状态统计 | 查看商户状态统计 |
| `monitor:callback:notify-logs` | 通知日志 | 查看通知日志 |
| `monitor:callback:merchant-detail` | 商户详情 | 查看商户详情 |
| `monitor:callback:reset-circuit-breaker` | 重置熔断器 | 重置商户熔断器 |
| `monitor:callback:trigger-notify` | 手动触发通知 | 手动触发商户通知 |
| `monitor:callback:system-health` | 系统健康状态 | 查看系统健康状态 |

### 权限分配
- 超级管理员自动拥有所有权限
- 其他用户组需要手动分配相应权限

## 使用指南

### 1. 访问监控面板
1. 登录管理后台
2. 在左侧菜单中找到"监控管理"
3. 点击"商户回调监控"进入监控页面

### 2. 查看实时数据
- 页面顶部显示最近1小时的通知统计
- 中间区域显示系统健康状态和队列状态
- 底部显示最近的通知日志

### 3. 管理商户状态
- 在商户状态统计表格中查看所有商户状态
- 点击"查看详情"查看具体商户信息
- 对于熔断的商户，可以点击"重置熔断器"恢复服务

### 4. 系统维护
- 定期检查系统健康状态
- 关注队列长度，避免积压
- 及时处理熔断商户

## 监控指标说明

### 1. 通知成功率
- **计算公式**: (成功通知数 / 总通知数) × 100%
- **正常范围**: > 95%
- **告警阈值**: < 90%

### 2. 商户响应时间
- **正常范围**: < 3秒
- **慢响应**: 3-10秒
- **超时**: > 10秒

### 3. 熔断器状态
- **触发条件**: 连续失败5次
- **熔断时长**: 5分钟
- **恢复条件**: 熔断期结束或手动重置

### 4. 队列状态
- **重试队列**: 正常 < 100，告警 > 1000
- **延迟队列**: 正常 < 50，告警 > 500

## 故障排查

### 1. 通知失败率高
- 检查商户服务器状态
- 验证通知地址有效性
- 查看网络连接情况
- 检查签名验证逻辑

### 2. 系统健康异常
- **Redis异常**: 检查Redis服务状态和连接配置
- **数据库异常**: 检查MySQL服务状态和连接池
- **队列异常**: 检查队列长度和处理速度
- **通知服务异常**: 检查通知服务配置和依赖

### 3. 商户熔断频繁
- 检查商户服务器性能
- 优化商户接口响应时间
- 调整熔断器参数
- 联系商户技术支持

## 性能优化

### 1. 数据库优化
- 为通知日志表添加合适的索引
- 定期清理历史日志数据
- 使用读写分离提升查询性能

### 2. Redis优化
- 合理设置缓存过期时间
- 监控Redis内存使用情况
- 使用Redis集群提升可用性

### 3. 前端优化
- 合理设置自动刷新间隔
- 使用虚拟滚动处理大量数据
- 实现数据缓存减少请求

## 扩展功能

### 1. 告警通知
- 集成邮件告警
- 集成短信告警
- 集成企业微信/钉钉告警

### 2. 数据分析
- 添加趋势图表
- 导出监控报告
- 历史数据对比

### 3. 自动化运维
- 自动重置熔断器
- 自动扩容队列
- 自动故障恢复

## 更新日志

### v1.0.0 (2024-01-XX)
- 初始版本发布
- 实现基础监控功能
- 支持实时数据展示
- 支持商户状态管理
- 支持系统健康检查

## 技术支持

如有问题或建议，请联系开发团队或提交Issue。


